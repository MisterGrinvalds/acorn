# FZF component configuration
name: fzf
description: Fuzzy finder with Catppuccin theme and shell integrations
version: 1.0.0

# Shell aliases
aliases:
  ff: "fzf_files"
  fcd: "fzf_cd"
  fgb: "fzf_git_branch"
  fgl: "fzf_git_log"
  fgs: "fzf_git_stash"
  fga: "fzf_git_add"
  fkill: "fzf_kill"
  fh: "fzf_history"
  fenv: "fzf_env"

# Shell functions (all fzf functions need to stay in shell)
shell_functions:
  # FZF environment setup
  _fzf_init: |
    # FZF Version Detection
    if command -v fzf >/dev/null 2>&1; then
        FZF_VERSION=$(fzf --version | cut -d' ' -f1)
        export FZF_VERSION
    fi

    # FZF Default Commands (use fd for faster search)
    case "$CURRENT_PLATFORM" in
        darwin)
            export FZF_DEFAULT_COMMAND='fd --type f --hidden --follow --exclude .git'
            export FZF_ALT_C_COMMAND='fd --type d --hidden --follow --exclude .git'
            ;;
        linux)
            if command -v fdfind >/dev/null 2>&1; then
                export FZF_DEFAULT_COMMAND='fdfind --type f --hidden --follow --exclude .git'
                export FZF_ALT_C_COMMAND='fdfind --type d --hidden --follow --exclude .git'
            elif command -v fd >/dev/null 2>&1; then
                export FZF_DEFAULT_COMMAND='fd --type f --hidden --follow --exclude .git'
                export FZF_ALT_C_COMMAND='fd --type d --hidden --follow --exclude .git'
            fi
            ;;
    esac

    export FZF_CTRL_T_COMMAND="$FZF_DEFAULT_COMMAND"

    # FZF Catppuccin Mocha Theme
    export FZF_DEFAULT_OPTS="
      --extended
      --height 40%
      --layout=reverse
      --border
      --color=bg+:#313244,bg:#1e1e2e,spinner:#f5e0dc,hl:#f38ba8
      --color=fg:#cdd6f4,header:#f38ba8,info:#cba6f7,pointer:#f5e0dc
      --color=marker:#f5e0dc,fg+:#cdd6f4,prompt:#cba6f7,hl+:#f38ba8
      --bind='ctrl-/:toggle-preview'
      --preview-window='right:50%:hidden'
    "

    # Preview options
    export FZF_CTRL_T_OPTS="--preview '[ -d {} ] && ls -la {} || head -100 {}'"
    export FZF_ALT_C_OPTS="--preview 'ls -la {}'"

    # FZF Location Detection
    if [ -z "$FZF_LOCATION" ]; then
        if [ -d "/opt/homebrew/opt/fzf" ]; then
            FZF_LOCATION="/opt/homebrew/opt/fzf"
        elif [ -d "/home/linuxbrew/.linuxbrew/opt/fzf" ]; then
            FZF_LOCATION="/home/linuxbrew/.linuxbrew/opt/fzf"
        elif [ -d "/usr/share/fzf" ]; then
            FZF_LOCATION="/usr/share/fzf"
        elif [ -d "$HOME/.fzf" ]; then
            FZF_LOCATION="$HOME/.fzf"
        fi
    fi
    export FZF_LOCATION

    # Source fzf shell integration (key bindings + completions)
    # This enables Ctrl+R, Ctrl+T, Alt+C to insert selection into command line
    if [ -n "$FZF_LOCATION" ]; then
        if [ -n "$BASH_VERSION" ]; then
            [ -f "$FZF_LOCATION/shell/key-bindings.bash" ] && source "$FZF_LOCATION/shell/key-bindings.bash"
            [ -f "$FZF_LOCATION/shell/completion.bash" ] && source "$FZF_LOCATION/shell/completion.bash"
        elif [ -n "$ZSH_VERSION" ]; then
            [ -f "$FZF_LOCATION/shell/key-bindings.zsh" ] && source "$FZF_LOCATION/shell/key-bindings.zsh"
            [ -f "$FZF_LOCATION/shell/completion.zsh" ] && source "$FZF_LOCATION/shell/completion.zsh"
        fi
    fi

  # Interactive file finder with preview
  fzf_files: |
    local file
    file=$(fzf --preview 'head -100 {}')
    [ -n "$file" ] && ${EDITOR:-vim} "$file"

  # Find and edit file
  fe: |
    local file
    file=$(fzf --query="$1" --select-1 --exit-0)
    [ -n "$file" ] && ${EDITOR:-vim} "$file"

  # Interactive cd with preview
  fzf_cd: |
    local dir
    case "$CURRENT_PLATFORM" in
        darwin) dir=$(fd --type d --hidden --follow --exclude .git 2>/dev/null | fzf --preview 'ls -la {}') ;;
        linux)  dir=$(fdfind --type d --hidden --follow --exclude .git 2>/dev/null | fzf --preview 'ls -la {}') ;;
        *)      dir=$(find . -type d 2>/dev/null | fzf --preview 'ls -la {}') ;;
    esac
    [ -n "$dir" ] && cd "$dir" || return

  # Interactive git branch checkout
  fzf_git_branch: |
    local branch
    branch=$(git branch --all | grep -v HEAD | sed 's/.* //' | sed 's#remotes/origin/##' | sort -u | fzf)
    [ -n "$branch" ] && git checkout "$branch"

  # Interactive git log browser
  fzf_git_log: |
    git log --oneline --color=always | fzf --ansi --preview 'git show --color=always {1}'

  # Interactive git stash browser
  fzf_git_stash: |
    local stash
    stash=$(git stash list | fzf --preview 'git stash show -p {1}' | cut -d: -f1)
    [ -n "$stash" ] && git stash apply "$stash"

  # Interactive git add
  fzf_git_add: |
    local files
    files=$(git status -s | fzf -m --preview 'git diff --color=always {2}' | awk '{print $2}')
    [ -n "$files" ] && echo "$files" | xargs git add

  # Interactive process killer
  fzf_kill: |
    local pid
    pid=$(ps aux | sed 1d | fzf -m | awk '{print $2}')
    [ -n "$pid" ] && echo "$pid" | xargs kill -"${1:-9}"

  # Interactive history search and execute
  fzf_history: |
    local cmd
    cmd=$(history | fzf --tac --no-sort | sed 's/^[ ]*[0-9]*[ ]*//')
    [ -n "$cmd" ] && eval "$cmd"

  # Interactive environment variable browser
  fzf_env: |
    local var
    var=$(env | fzf | cut -d= -f1)
    [ -n "$var" ] && echo "${var}=$(printenv "$var")"

  # Kubernetes integrations (conditional)
  _fzf_k8s_init: |
    if command -v kubectl >/dev/null 2>&1; then
        # Interactive pod selector
        fzf_k8s_pod() {
            kubectl get pods --all-namespaces -o wide | fzf | awk '{print $2}'
        }

        # Interactive pod logs
        fzf_k8s_logs() {
            local selection ns pod
            selection=$(kubectl get pods --all-namespaces -o wide | fzf)
            if [ -n "$selection" ]; then
                ns=$(echo "$selection" | awk '{print $1}')
                pod=$(echo "$selection" | awk '{print $2}')
                kubectl logs -n "$ns" "$pod" -f
            fi
        }
        alias fkl='fzf_k8s_logs'

        # Interactive namespace switcher
        fzf_k8s_ns() {
            local ns
            ns=$(kubectl get namespaces -o name | sed 's/namespace\///' | fzf)
            [ -n "$ns" ] && kubectl config set-context --current --namespace="$ns"
        }
        alias fkns='fzf_k8s_ns'
    fi

  # Docker integrations (conditional)
  _fzf_docker_init: |
    if command -v docker >/dev/null 2>&1; then
        # Interactive container selector
        fzf_docker_container() {
            docker ps -a --format "table {{.ID}}\t{{.Names}}\t{{.Status}}\t{{.Image}}" | fzf | awk '{print $1}'
        }

        # Interactive container logs
        fzf_docker_logs() {
            local container
            container=$(fzf_docker_container)
            [ -n "$container" ] && docker logs -f "$container"
        }
        alias fdl='fzf_docker_logs'

        # Interactive container exec
        fzf_docker_exec() {
            local container
            container=$(fzf_docker_container)
            [ -n "$container" ] && docker exec -it "$container" "${1:-/bin/sh}"
        }
        alias fdx='fzf_docker_exec'
    fi
