# Tmux component configuration
name: tmux
description: Tmux session management with TPM and smug
version: 1.0.0

# Environment variables
env:
  TMUX_CONFIG_DIR: "${XDG_CONFIG_HOME:-$HOME/.config}/tmux"
  TMUX_PLUGIN_DIR: "${TMUX_CONFIG_DIR}/plugins"
  TMUX_TPM_DIR: "${TMUX_PLUGIN_DIR}/tpm"
  TMUX_CONF: "${TMUX_CONFIG_DIR}/tmux.conf"
  SMUG_REPO: "https://github.com/MisterGrinvalds/fmux.git"
  SMUG_REPO_DIR: "${XDG_DATA_HOME:-$HOME/.local/share}/smug-sessions"
  SMUG_CONFIG_DIR: "${XDG_CONFIG_HOME:-$HOME/.config}/smug"

# Shell aliases
aliases:
  tm: "tmux"
  tma: "tmux attach-session"
  tmat: "tmux attach-session -t"
  tmn: "tmux new-session"
  tmns: "tmux new-session -s"
  tml: "tmux list-sessions"
  tmk: "tmux kill-session -t"
  tmka: "tmux kill-server"
  tmx: "tmux attach-session 2>/dev/null || tmux new-session"
  tm0: "tmux attach-session -t 0"
  tm1: "tmux attach-session -t 1"
  tmdev: "tmux attach-session -t dev 2>/dev/null || dev_session"

# Wrapper functions for acorn commands
wrappers:
  - name: tmux_install_tpm
    command: "acorn tmux tpm install"

  - name: tmux_update_tpm
    command: "acorn tmux tpm update"

  - name: tmux_install_plugins
    command: "acorn tmux tpm plugins-install"

  - name: tmux_update_plugins
    command: "acorn tmux tpm plugins-update"

  - name: tmux_reload
    command: "acorn tmux config reload"

  - name: tmux_info
    command: "acorn tmux info"

  - name: smug_list
    command: "acorn tmux smug list"

  - name: smug_new
    command: "acorn tmux smug new"

  - name: smug_install
    command: "acorn tmux smug install"

  - name: smug_link_configs
    command: "acorn tmux smug link"

  - name: smug_repo_init
    command: "acorn tmux smug repo-init"

  - name: smug_status
    command: "acorn tmux smug status"

  - name: smug_pull
    command: "acorn tmux smug pull"

  - name: smug_push
    command: "acorn tmux smug push"

  - name: smug_sync
    command: "acorn tmux smug sync"

# Shell functions (tmux attach, fzf selection, etc.)
shell_functions:
  # Development session with multiple panes
  dev_session: |
    local session_name="${1:-dev}"
    tmux new-session -d -s "$session_name"
    tmux split-window -h -t "$session_name"
    tmux split-window -v -t "$session_name:0.1"
    tmux send-keys -t "$session_name:0.0" 'echo "Editor pane"' Enter
    tmux send-keys -t "$session_name:0.1" 'echo "Main terminal"' Enter
    tmux send-keys -t "$session_name:0.2" 'echo "Logs/monitoring pane"' Enter
    tmux select-pane -t "$session_name:0.0"
    tmux attach-session -t "$session_name"

  # Kubernetes development session
  k8s_session: |
    local session_name="k8s"
    tmux new-session -d -s "$session_name"
    tmux new-window -t "$session_name" -n "kubectl"
    tmux new-window -t "$session_name" -n "logs"
    tmux new-window -t "$session_name" -n "k9s"
    tmux send-keys -t "$session_name:kubectl" 'echo "kubectl commands"' Enter
    tmux split-window -h -t "$session_name:logs"
    tmux send-keys -t "$session_name:logs.0" 'echo "App logs"' Enter
    tmux send-keys -t "$session_name:logs.1" 'echo "System logs"' Enter
    tmux send-keys -t "$session_name:k9s" 'k9s' Enter
    tmux select-window -t "$session_name:1"
    tmux attach-session -t "$session_name"

  # Project session (auto-detects project type)
  project_session: |
    local project_path="${1:-.}"
    local session_name
    session_name=$(basename "$(realpath "$project_path")")
    cd "$project_path" || return 1
    tmux new-session -d -s "$session_name" -c "$project_path"
    if [ -f "go.mod" ]; then
        tmux send-keys -t "$session_name" 'echo "Go project detected"' Enter
        tmux new-window -t "$session_name" -n "test" -c "$project_path"
        tmux new-window -t "$session_name" -n "run" -c "$project_path"
    elif [ -f "requirements.txt" ] || [ -f "pyproject.toml" ]; then
        tmux send-keys -t "$session_name" 'echo "Python project detected"' Enter
        tmux new-window -t "$session_name" -n "test" -c "$project_path"
        tmux new-window -t "$session_name" -n "server" -c "$project_path"
    elif [ -f "package.json" ]; then
        tmux send-keys -t "$session_name" 'echo "Node.js project detected"' Enter
        tmux new-window -t "$session_name" -n "dev" -c "$project_path"
        tmux new-window -t "$session_name" -n "test" -c "$project_path"
    fi
    tmux new-window -t "$session_name" -n "editor" -c "$project_path"
    tmux send-keys -t "$session_name:editor" 'code .' Enter
    tmux select-window -t "$session_name:1"
    tmux attach-session -t "$session_name"

  # Session switcher using fzf
  tswitch: |
    if ! command -v fzf >/dev/null 2>&1; then
        echo "fzf is required for tswitch"
        return 1
    fi
    local session
    session=$(tmux list-sessions -F '#S' | fzf --prompt="Switch to session: ")
    if [ -n "$session" ]; then
        tmux attach-session -t "$session"
    fi

  # Kill session with fzf selection
  tkill: |
    if ! command -v fzf >/dev/null 2>&1; then
        echo "fzf is required for tkill"
        return 1
    fi
    local session
    session=$(tmux list-sessions -F '#S' | fzf --prompt="Kill session: ")
    if [ -n "$session" ]; then
        tmux kill-session -t "$session"
        echo "Killed session: $session"
    fi

  # Attach or create session
  tmux_attach: |
    local session="${1:-main}"
    if tmux has-session -t "$session" 2>/dev/null; then
        tmux attach-session -t "$session"
    else
        echo "Creating new session: $session"
        tmux new-session -s "$session"
    fi

  # Edit tmux config
  tmux_config: |
    local config="${TMUX_CONF:-$HOME/.config/tmux/tmux.conf}"
    if [ ! -f "$config" ]; then
        echo "Tmux config not found: $config"
        return 1
    fi
    ${EDITOR:-vim} "$config"
    echo "Config saved. Run 'tmux_reload' or prefix + r to reload."

  # Start smug session with fzf
  smug_start: |
    local session="$1"
    local smug_dir="${SMUG_CONFIG_DIR:-$HOME/.config/smug}"
    if ! command -v smug >/dev/null 2>&1; then
        echo "smug not installed. Run: acorn tmux smug install"
        return 1
    fi
    if [ -z "$session" ]; then
        if ! command -v fzf >/dev/null 2>&1; then
            echo "Usage: smug_start <session_name>"
            smug_list
            return 1
        fi
        session=$(ls "$smug_dir"/*.yml 2>/dev/null | xargs -I {} basename {} .yml | fzf --prompt="Start session: ")
        [ -z "$session" ] && return 0
    fi
    shift 2>/dev/null
    smug start "$session" "$@"

  # Stop smug session with fzf
  smug_stop: |
    local session="$1"
    if ! command -v smug >/dev/null 2>&1; then
        echo "smug not installed"
        return 1
    fi
    if [ -z "$session" ]; then
        if ! command -v fzf >/dev/null 2>&1; then
            echo "Usage: smug_stop <session_name>"
            return 1
        fi
        session=$(tmux list-sessions -F '#S' 2>/dev/null | fzf --prompt="Stop session: ")
        [ -z "$session" ] && return 0
    fi
    smug stop "$session"

  # Edit smug config
  smug_edit: |
    local name="$1"
    local smug_dir="${SMUG_CONFIG_DIR:-$HOME/.config/smug}"
    if ! command -v smug >/dev/null 2>&1; then
        echo "smug not installed"
        return 1
    fi
    if [ -z "$name" ]; then
        if command -v fzf >/dev/null 2>&1; then
            name=$(ls "$smug_dir"/*.yml 2>/dev/null | xargs -I {} basename {} .yml | fzf --prompt="Edit config: ")
            [ -z "$name" ] && return 0
        else
            echo "Usage: smug_edit <session_name>"
            return 1
        fi
    fi
    local config_file="$smug_dir/$name.yml"
    if [ ! -f "$config_file" ]; then
        echo "Config not found: $config_file"
        return 1
    fi
    ${EDITOR:-vim} "$config_file"

  # Window alert (red)
  tmux_alert: |
    if [ -z "$TMUX" ]; then
        echo "Error: Not in a tmux session"
        return 1
    fi
    local window_id
    window_id=$(tmux display-message -p '#{window_id}')
    tmux set-window-option -t "$window_id" @alert 1
    tmux set-window-option -t "$window_id" window-status-style "fg=#f38ba8,bold,bg=#45475a"
    echo "Alert set for window $window_id"

  # Window alert with custom color
  tmux_alert_color: |
    if [ -z "$TMUX" ]; then
        echo "Error: Not in a tmux session"
        return 1
    fi
    local color="${1:-#f38ba8}"
    local window_id
    window_id=$(tmux display-message -p '#{window_id}')
    tmux set-window-option -t "$window_id" @alert 1
    tmux set-window-option -t "$window_id" window-status-style "fg=$color,bold,bg=#45475a"
    echo "Alert set with color: $color"

  # Priority alert shortcuts
  tmux_alert_high: |
    tmux_alert_color "#f38ba8"

  tmux_alert_medium: |
    tmux_alert_color "#f9e2af"

  tmux_alert_low: |
    tmux_alert_color "#94e2d5"

  # Clear window alert (called by tmux hook: after-select-window)
  tmux_clear_alert: |
    local window_id="${1:-$(tmux display-message -p '#{window_id}')}"
    local alert_flag
    alert_flag=$(tmux show-window-options -t "$window_id" -v @alert 2>/dev/null)
    if [ "$alert_flag" = "1" ]; then
        tmux set-window-option -t "$window_id" @alert 0
        # Reset to default Catppuccin Mocha style
        tmux set-window-option -t "$window_id" window-status-style "fg=#bac2de,bg=#45475a"
    fi
