# Tmux component configuration
name: tmux
description: Tmux session management with TPM and smug
version: 1.0.0

# Environment variables
env:
  TMUX_CONFIG_DIR: "${XDG_CONFIG_HOME:-$HOME/.config}/tmux"
  TMUX_PLUGIN_DIR: "${TMUX_CONFIG_DIR}/plugins"
  TMUX_TPM_DIR: "${TMUX_PLUGIN_DIR}/tpm"
  TMUX_CONF: "${TMUX_CONFIG_DIR}/tmux.conf"
  SMUG_REPO: "https://github.com/MisterGrinvalds/fmux.git"
  SMUG_REPO_DIR: "${XDG_DATA_HOME:-$HOME/.local/share}/smug-sessions"
  SMUG_CONFIG_DIR: "${XDG_CONFIG_HOME:-$HOME/.config}/smug"
  TMUX_REPOS_DIR: "${HOME}/Repos"
  # Tmux window/status colors (Catppuccin Mocha)
  TMUX_FG_DEFAULT: "#bac2de"
  TMUX_FG_PROCESSING: "#f9e2af"
  TMUX_FG_WAITING: "#fab387"
  TMUX_FG_DONE: "#a6e3a1"
  TMUX_FG_ERROR: "#f38ba8"
  TMUX_BG_INACTIVE: "#45475a"
  TMUX_BG_ACTIVE: "#f5c2e7"
  # Claude-specific aliases (reference base TMUX colors)
  CLAUDE_TMUX_FG_DEFAULT: "${TMUX_FG_DEFAULT}"
  CLAUDE_TMUX_FG_PROCESSING: "${TMUX_FG_PROCESSING}"
  CLAUDE_TMUX_FG_WAITING: "${TMUX_FG_WAITING}"
  CLAUDE_TMUX_FG_DONE: "${TMUX_FG_DONE}"
  CLAUDE_TMUX_FG_ERROR: "${TMUX_FG_ERROR}"
  CLAUDE_TMUX_BG_INACTIVE: "${TMUX_BG_INACTIVE}"
  CLAUDE_TMUX_BG_ACTIVE: "${TMUX_BG_ACTIVE}"

# Shell aliases
aliases:
  tm: "tmux"
  tma: "tmux attach-session"
  tmat: "tmux attach-session -t"
  tmn: "tmux new-session"
  tmns: "tmux new-session -s"
  tml: "tmux list-sessions"
  tmk: "tmux kill-session -t"
  tmka: "tmux kill-server"
  tmx: "tmux attach-session 2>/dev/null || tmux new-session"
  tm0: "tmux attach-session -t 0"
  tm1: "tmux attach-session -t 1"
  tmdev: "tmux attach-session -t dev 2>/dev/null || dev_session"

# Wrapper functions for acorn commands
wrappers:
  - name: tmux_install_tpm
    command: "acorn tmux tpm install"

  - name: tmux_update_tpm
    command: "acorn tmux tpm update"

  - name: tmux_install_plugins
    command: "acorn tmux tpm plugins-install"

  - name: tmux_update_plugins
    command: "acorn tmux tpm plugins-update"

  - name: tmux_reload
    command: "acorn tmux config reload"

  - name: tmux_info
    command: "acorn tmux info"

  - name: smug_list
    command: "acorn tmux smug list"

  - name: smug_new
    command: "acorn tmux smug new"

  - name: smug_install
    command: "acorn tmux smug install"

  - name: smug_link_configs
    command: "acorn tmux smug link"

  - name: smug_repo_init
    command: "acorn tmux smug repo-init"

  - name: smug_status
    command: "acorn tmux smug status"

  - name: smug_pull
    command: "acorn tmux smug pull"

  - name: smug_push
    command: "acorn tmux smug push"

  - name: smug_sync
    command: "acorn tmux smug sync"

# Shell functions (tmux attach, fzf selection, etc.)
shell_functions:
  # Development session with multiple panes
  dev_session: |
    local session_name="${1:-dev}"
    tmux new-session -d -s "$session_name"
    tmux split-window -h -t "$session_name"
    tmux split-window -v -t "$session_name:0.1"
    tmux send-keys -t "$session_name:0.0" 'echo "Editor pane"' Enter
    tmux send-keys -t "$session_name:0.1" 'echo "Main terminal"' Enter
    tmux send-keys -t "$session_name:0.2" 'echo "Logs/monitoring pane"' Enter
    tmux select-pane -t "$session_name:0.0"
    tmux attach-session -t "$session_name"

  # Kubernetes development session
  k8s_session: |
    local session_name="k8s"
    tmux new-session -d -s "$session_name"
    tmux new-window -t "$session_name" -n "kubectl"
    tmux new-window -t "$session_name" -n "logs"
    tmux new-window -t "$session_name" -n "k9s"
    tmux send-keys -t "$session_name:kubectl" 'echo "kubectl commands"' Enter
    tmux split-window -h -t "$session_name:logs"
    tmux send-keys -t "$session_name:logs.0" 'echo "App logs"' Enter
    tmux send-keys -t "$session_name:logs.1" 'echo "System logs"' Enter
    tmux send-keys -t "$session_name:k9s" 'k9s' Enter
    tmux select-window -t "$session_name:1"
    tmux attach-session -t "$session_name"

  # Project session (auto-detects project type)
  project_session: |
    local project_path="${1:-.}"
    local session_name
    session_name=$(basename "$(realpath "$project_path")")
    cd "$project_path" || return 1
    tmux new-session -d -s "$session_name" -c "$project_path"
    if [ -f "go.mod" ]; then
        tmux send-keys -t "$session_name" 'echo "Go project detected"' Enter
        tmux new-window -t "$session_name" -n "test" -c "$project_path"
        tmux new-window -t "$session_name" -n "run" -c "$project_path"
    elif [ -f "requirements.txt" ] || [ -f "pyproject.toml" ]; then
        tmux send-keys -t "$session_name" 'echo "Python project detected"' Enter
        tmux new-window -t "$session_name" -n "test" -c "$project_path"
        tmux new-window -t "$session_name" -n "server" -c "$project_path"
    elif [ -f "package.json" ]; then
        tmux send-keys -t "$session_name" 'echo "Node.js project detected"' Enter
        tmux new-window -t "$session_name" -n "dev" -c "$project_path"
        tmux new-window -t "$session_name" -n "test" -c "$project_path"
    fi
    tmux new-window -t "$session_name" -n "editor" -c "$project_path"
    tmux send-keys -t "$session_name:editor" 'code .' Enter
    tmux select-window -t "$session_name:1"
    tmux attach-session -t "$session_name"

  # Session switcher using fzf
  tswitch: |
    if ! command -v fzf >/dev/null 2>&1; then
        echo "fzf is required for tswitch"
        return 1
    fi
    local session
    session=$(tmux list-sessions -F '#S' | fzf --prompt="Switch to session: ")
    if [ -n "$session" ]; then
        tmux attach-session -t "$session"
    fi

  # Kill session with fzf selection
  tkill: |
    if ! command -v fzf >/dev/null 2>&1; then
        echo "fzf is required for tkill"
        return 1
    fi
    local session
    session=$(tmux list-sessions -F '#S' | fzf --prompt="Kill session: ")
    if [ -n "$session" ]; then
        tmux kill-session -t "$session"
        echo "Killed session: $session"
    fi

  # Attach or create session
  tmux_attach: |
    local session="${1:-main}"
    if tmux has-session -t "$session" 2>/dev/null; then
        tmux attach-session -t "$session"
    else
        echo "Creating new session: $session"
        tmux new-session -s "$session"
    fi

  # Edit tmux config
  tmux_config: |
    local config="${TMUX_CONF:-$HOME/.config/tmux/tmux.conf}"
    if [ ! -f "$config" ]; then
        echo "Tmux config not found: $config"
        return 1
    fi
    ${EDITOR:-vim} "$config"
    echo "Config saved. Run 'tmux_reload' or prefix + r to reload."

  # Start smug session with fzf
  smug_start: |
    local session="$1"
    local smug_dir="${SMUG_CONFIG_DIR:-$HOME/.config/smug}"
    if ! command -v smug >/dev/null 2>&1; then
        echo "smug not installed. Run: acorn tmux smug install"
        return 1
    fi
    if [ -z "$session" ]; then
        if ! command -v fzf >/dev/null 2>&1; then
            echo "Usage: smug_start <session_name>"
            smug_list
            return 1
        fi
        session=$(ls "$smug_dir"/*.yml 2>/dev/null | xargs -I {} basename {} .yml | fzf --prompt="Start session: ")
        [ -z "$session" ] && return 0
    fi
    shift 2>/dev/null
    smug start "$session" "$@"

  # Stop smug session with fzf
  smug_stop: |
    local session="$1"
    if ! command -v smug >/dev/null 2>&1; then
        echo "smug not installed"
        return 1
    fi
    if [ -z "$session" ]; then
        if ! command -v fzf >/dev/null 2>&1; then
            echo "Usage: smug_stop <session_name>"
            return 1
        fi
        session=$(tmux list-sessions -F '#S' 2>/dev/null | fzf --prompt="Stop session: ")
        [ -z "$session" ] && return 0
    fi
    smug stop "$session"

  # Edit smug config
  smug_edit: |
    local name="$1"
    local smug_dir="${SMUG_CONFIG_DIR:-$HOME/.config/smug}"
    if ! command -v smug >/dev/null 2>&1; then
        echo "smug not installed"
        return 1
    fi
    if [ -z "$name" ]; then
        if command -v fzf >/dev/null 2>&1; then
            name=$(ls "$smug_dir"/*.yml 2>/dev/null | xargs -I {} basename {} .yml | fzf --prompt="Edit config: ")
            [ -z "$name" ] && return 0
        else
            echo "Usage: smug_edit <session_name>"
            return 1
        fi
    fi
    local config_file="$smug_dir/$name.yml"
    if [ ! -f "$config_file" ]; then
        echo "Config not found: $config_file"
        return 1
    fi
    ${EDITOR:-vim} "$config_file"

  # Window alert (error/high priority - red)
  tmux_alert: |
    if [ -z "$TMUX" ]; then
        echo "Error: Not in a tmux session"
        return 1
    fi
    local window_id
    window_id=$(tmux display-message -p '#{window_id}')
    local fg="${TMUX_FG_ERROR:-#f38ba8}"
    local bg="${TMUX_BG_INACTIVE:-#45475a}"
    tmux set-window-option -t "$window_id" @alert 1
    tmux set-window-option -t "$window_id" window-status-style "fg=$fg,bold,bg=$bg"
    echo "Alert set for window $window_id"

  # Window alert with custom color
  tmux_alert_color: |
    if [ -z "$TMUX" ]; then
        echo "Error: Not in a tmux session"
        return 1
    fi
    local color="${1:-${TMUX_FG_ERROR:-#f38ba8}}"
    local bg="${TMUX_BG_INACTIVE:-#45475a}"
    local window_id
    window_id=$(tmux display-message -p '#{window_id}')
    tmux set-window-option -t "$window_id" @alert 1
    tmux set-window-option -t "$window_id" window-status-style "fg=$color,bold,bg=$bg"
    echo "Alert set with color: $color"

  # Priority alert shortcuts
  tmux_alert_high: |
    tmux_alert_color "${TMUX_FG_ERROR:-#f38ba8}"

  tmux_alert_medium: |
    tmux_alert_color "${TMUX_FG_PROCESSING:-#f9e2af}"

  tmux_alert_low: |
    tmux_alert_color "${TMUX_FG_DONE:-#a6e3a1}"

  # Status-based alerts for Claude/processing workflows
  tmux_alert_processing: |
    tmux_alert_color "${TMUX_FG_PROCESSING:-#f9e2af}"

  tmux_alert_waiting: |
    tmux_alert_color "${TMUX_FG_WAITING:-#fab387}"

  tmux_alert_done: |
    tmux_alert_color "${TMUX_FG_DONE:-#a6e3a1}"

  tmux_alert_error: |
    tmux_alert_color "${TMUX_FG_ERROR:-#f38ba8}"

  # Clear window alert (called by tmux hook: after-select-window)
  tmux_clear_alert: |
    local window_id="${1:-$(tmux display-message -p '#{window_id}')}"
    local alert_flag
    alert_flag=$(tmux show-window-options -t "$window_id" -v @alert 2>/dev/null)
    if [ "$alert_flag" = "1" ]; then
        tmux set-window-option -t "$window_id" @alert 0
        local bg="${TMUX_BG_INACTIVE:-#45475a}"
        # Reset to default style
        tmux set-window-option -t "$window_id" window-status-style "fg=#bac2de,bg=$bg"
    fi

  # Open a new tmux window in a repo selected via fzf
  trepo: |
    if [ -z "$TMUX" ]; then
        echo "Error: Not in a tmux session"
        return 1
    fi
    if ! command -v fzf >/dev/null 2>&1; then
        echo "fzf is required for trepo"
        return 1
    fi
    local repos_dir="${TMUX_REPOS_DIR:-$HOME/Repos}"
    local max_depth="${1:-4}"
    if [ ! -d "$repos_dir" ]; then
        echo "Repos directory not found: $repos_dir"
        echo "Set TMUX_REPOS_DIR to your repos base directory"
        return 1
    fi
    local repo
    repo=$(find "$repos_dir" -maxdepth "$max_depth" -type d -name ".git" 2>/dev/null | \
        sed 's|/\.git$||' | \
        sed "s|^$repos_dir/||" | \
        sort | \
        fzf --prompt="Open repo: " --preview "ls -la $repos_dir/{}")
    if [ -n "$repo" ]; then
        local full_path="$repos_dir/$repo"
        local window_name
        window_name=$(basename "$repo")
        tmux new-window -n "$window_name" -c "$full_path"
        echo "Opened window '$window_name' in $full_path"
    fi

# Config file generation
files:
  - target: "${XDG_CONFIG_HOME:-$HOME/.config}/tmux/tmux.conf"
    format: tmux
    values:
      # General Settings
      set_g:
        default-terminal: '"tmux-256color"'
        mouse: true
        base-index: 1
        pane-base-index: 1
        renumber-windows: true
        history-limit: 50000
        monitor-activity: true
        visual-activity: false
        focus-events: true
        allow-passthrough: true
        mode-keys: vi
        status: true
        status-interval: 1
        status-position: bottom
        status-justify: left
        # Catppuccin Mocha theme
        status-style: '"bg=#1e1e2e,fg=#cdd6f4"'
        status-left-length: 60
        status-left: '"#{?client_prefix,#[bg=#f38ba8 fg=#1e1e2e bold] P ,#[bg=#89b4fa fg=#1e1e2e bold] #S } "'
        status-right-length: 100
        status-right: '"#[fg=#45475a]#[fg=#cdd6f4,bg=#45475a] %Y-%m-%d  %H:%M #[fg=#89b4fa,bg=#45475a]#[fg=#1e1e2e,bg=#89b4fa,bold] #h "'
        window-status-format: '"#[fg=#45475a,bg=#1e1e2e]#[fg=#bac2de,bg=#45475a] #I  #W #[fg=#45475a,bg=#1e1e2e]"'
        window-status-current-format: '"#[fg=#f5c2e7,bg=#1e1e2e]#[bold,fg=#1e1e2e,bg=#f5c2e7] #I  #W #[nobold,fg=#f5c2e7,bg=#1e1e2e]"'
        pane-border-style: '"fg=#45475a"'
        pane-active-border-style: '"fg=#89b4fa"'
        message-style: '"bg=#313244,fg=#cdd6f4"'
        message-command-style: '"bg=#313244,fg=#cdd6f4"'
        mode-style: '"bg=#45475a,fg=#cdd6f4"'
        clock-mode-colour: '"#89b4fa"'
        # Prefix keys
        prefix: C-b
        prefix2: C-a

      set_s:
        escape-time: 2
        extended-keys: true

      set_w:
        pane-base-index: 1

      set_ga:
        terminal-overrides: '",xterm-256color:Tc,xterm-ghostty:Tc"'

      # Append server options (list format for multiple values)
      set_as:
        - "update-environment TERM"
        - "update-environment TERM_PROGRAM"

      terminal_features:
        - ",xterm-256color:mouse"
        - ",xterm-ghostty:mouse"
        - "xterm*:extkeys"

      unbind:
        - '"'
        - "%"

      unbind_n:
        - C-r

      bind:
        C-a: send-prefix
        C-b: send-prefix -2
        r: 'source-file ~/.config/tmux/tmux.conf \; display "Config reloaded!"'
        "|": 'split-window -h -c "#{pane_current_path}"'
        "-": 'split-window -v -c "#{pane_current_path}"'
        v: 'split-window -h -c "#{pane_current_path}"'
        s: 'split-window -v -c "#{pane_current_path}"'
        c: 'new-window -c "#{pane_current_path}"'
        h: select-pane -L
        j: select-pane -D
        k: select-pane -U
        l: select-pane -R
        x: kill-pane
        X: kill-window
        S: 'set-window-option synchronize-panes \; display "Sync #{?synchronize-panes,ON,OFF}"'
        "[": copy-mode
        "(": switch-client -p
        ")": switch-client -n
        w: choose-tree -Zs

      bind_n:
        S-Left: previous-window
        S-Right: next-window

      bind_r:
        Tab: next-window
        BTab: previous-window
        H: resize-pane -L 5
        J: resize-pane -D 5
        K: resize-pane -U 5
        L: resize-pane -R 5

      bind_T:
        root:
          MouseDown1Pane: 'if-shell -F "#{mouse_any_flag}" "send-keys -M" "select-pane -t = \; send-keys -M"'
          MouseDrag1Pane: 'if-shell -F "#{mouse_any_flag}" "send-keys -M" "select-pane -t = \; send-keys -M"'
          DoubleClick1Pane: 'if-shell -F "#{mouse_any_flag}" "send-keys -M" "select-pane -t = \; copy-mode -H \; send-keys -X select-word"'
          TripleClick1Pane: 'if-shell -F "#{mouse_any_flag}" "send-keys -M" "select-pane -t = \; copy-mode -H \; send-keys -X select-line"'
        copy-mode-vi:
          v: send-keys -X begin-selection
          C-v: send-keys -X rectangle-toggle
          y: send-keys -X copy-selection-and-cancel

      raw:
        - "# macOS clipboard integration"
        - 'if-shell "uname | grep -q Darwin" {'
        - '    bind -T copy-mode-vi y send-keys -X copy-pipe-and-cancel "pbcopy"'
        - '    bind -T copy-mode-vi MouseDragEnd1Pane send-keys -X copy-pipe-and-cancel "pbcopy"'
        - "}"
        - ""
        - "# Linux clipboard integration (requires xclip)"
        - 'if-shell "uname | grep -q Linux" {'
        - '    bind -T copy-mode-vi y send-keys -X copy-pipe-and-cancel "xclip -in -selection clipboard"'
        - "}"

      plugins:
        - tmux-plugins/tpm
        - tmux-plugins/tmux-sensible
        - tmux-plugins/tmux-resurrect
        - tmux-plugins/tmux-continuum
        - 27medkamal/tmux-session-wizard

      plugin_options:
        resurrect-capture-pane-contents: "'on'"
        continuum-restore: "'on'"
        continuum-save-interval: "'10'"
        session-wizard: "'T'"
        session-wizard-height: 40
        session-wizard-width: 80

      run:
        - "~/.config/tmux/plugins/tpm/tpm"

  # Smug session: dev - General development workspace
  - target: "~/.config/smug/dev.yml"
    format: raw
    values:
      content: |
        # smug session: dev
        # General development workspace
        # Usage: smug start dev

        session: dev
        root: ~/
        attach: true

        windows:
          - name: editor
            root: ~/Repos
            commands:
              - nvim

          - name: terminal
            root: ~/Repos
            panes:
              - type: horizontal
                root: ~/Repos
                commands:
                  - echo "Main terminal"
              - type: horizontal
                root: ~/Repos
                commands:
                  - echo "Secondary terminal"

          - name: logs
            commands:
              - echo "Logs/monitoring pane"

  # Smug session: k8s - Kubernetes development workspace
  - target: "~/.config/smug/k8s.yml"
    format: raw
    values:
      content: |
        # smug session: k8s
        # Kubernetes development workspace
        # Usage: smug start k8s

        session: k8s
        root: ~/
        attach: true

        windows:
          - name: kubectl
            commands:
              - kubectl get pods

          - name: logs
            panes:
              - type: horizontal
                commands:
                  - echo "App logs - use: kubectl logs -f <pod>"
              - type: horizontal
                commands:
                  - echo "System logs"

          - name: k9s
            commands:
              - k9s

          - name: helm
            commands:
              - echo "Helm commands"

  # Smug session: project - Project-specific workspace template
  - target: "~/.config/smug/project.yml"
    format: raw
    values:
      content: |
        # smug session: project
        # Project-specific workspace template
        # Usage: smug start project root=/path/to/project name=myproject
        # Variables: root (project path), name (session name)

        session: ${name:-project}
        root: ${root:-.}
        attach: true

        before_start:
          - echo "Starting project session..."

        windows:
          - name: code
            commands:
              - nvim .

          - name: shell
            panes:
              - type: horizontal
                commands:
                  - git status
              - type: horizontal
                commands:
                  - echo "Ready for commands"

          - name: server
            commands:
              - echo "Server/runner pane - start your dev server here"

          - name: tests
            commands:
              - echo "Test runner pane"

# Installation configuration
install:
  tools:
    - name: tmux
      description: Terminal multiplexer
      check: "command -v tmux"
      methods:
        darwin:
          type: brew
          package: tmux
        linux:
          type: apt
          package: tmux
      post_install:
        message: "Run 'acorn tmux tpm install' to install TPM plugin manager"

    - name: smug
      description: Tmux session manager
      check: "command -v smug"
      methods:
        darwin:
          type: go
          package: github.com/ivaaaan/smug@latest
        linux:
          type: go
          package: github.com/ivaaaan/smug@latest
      requires:
        - go:go
      post_install:
        message: "Run 'smug_start' to launch a session"

    - name: fzf
      description: Fuzzy finder for session selection
      check: "command -v fzf"
      methods:
        darwin:
          type: brew
          package: fzf
        linux:
          type: apt
          package: fzf
      post_install:
        message: "fzf enables tswitch, tkill, and smug_start selection"
