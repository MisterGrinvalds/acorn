# Node.js component configuration
name: node
description: Node.js, NVM, and pnpm management
version: 1.0.0

# Environment variables
env:
  NVM_DIR: "${XDG_DATA_HOME:-$HOME/.local/share}/nvm"
  PNPM_HOME: "${XDG_DATA_HOME:-$HOME/.local/share}/pnpm"
  npm_config_cache: "${XDG_CACHE_HOME:-$HOME/.cache}/npm"

# Paths to add
paths:
  - path: "$PNPM_HOME"

# Shell aliases
aliases:
  # npm shortcuts
  ni: "npm install"
  nid: "npm install --save-dev"
  nig: "npm install -g"
  nr: "npm run"
  nrd: "npm run dev"
  nrt: "npm run test"
  nrb: "npm run build"
  nrs: "npm run start"
  # pnpm shortcuts
  pi: "pnpm install"
  pa: "pnpm add"
  pad: "pnpm add -D"
  pr: "pnpm run"
  prd: "pnpm run dev"
  prt: "pnpm run test"
  prb: "pnpm run build"
  prs: "pnpm run start"
  # npx shortcuts
  nx: "npx"
  # NVM shortcuts
  nvml: "nvm ls"
  nvmr: "nvm ls-remote"
  nvmu: "nvm use"
  nvmi: "nvm install"

# Wrapper functions
wrappers:
  - name: node_status
    command: "acorn node status"

  - name: npm_detect
    command: "acorn node detect"

  - name: nfind
    command: "acorn node find"

  - name: nclean
    command: "acorn node clean"

  - name: nvm_status
    command: "acorn nvm status"

  - name: nvm_setup
    command: "acorn nvm install"

  - name: pnpm_status
    command: "acorn pnpm status"

# Shell functions (source nvm, interactive, cd)
shell_functions:
  # Load NVM on shell init
  _nvm_init: |
    [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"
    [ -s "$NVM_DIR/bash_completion" ] && . "$NVM_DIR/bash_completion"

  # Remove all node_modules with confirmation
  ncleanall: |
    if [ "$1" = "-f" ] || [ "$1" = "--force" ]; then
        acorn node cleanall --force "$@"
    else
        acorn node find
        echo ""
        printf "Remove all? [y/N] "
        read -r confirm
        if [ "$confirm" = "y" ] || [ "$confirm" = "Y" ]; then
            acorn node cleanall --force
        fi
    fi

  # Install and use latest LTS
  nvm_latest: |
    if ! command -v nvm >/dev/null 2>&1; then
        echo "NVM not installed. Run: acorn nvm install"
        return 1
    fi
    nvm install --lts
    nvm use --lts

  # Create new Node.js project with TypeScript
  node_init: |
    local name="${1:-.}"

    if [ "$name" != "." ]; then
        mkdir -p "$name"
        cd "$name" || return 1
    fi

    echo "Initializing Node.js project..."

    # Initialize package.json
    if command -v pnpm >/dev/null 2>&1; then
        pnpm init
        pnpm add -D typescript @types/node tsx
    else
        npm init -y
        npm install --save-dev typescript @types/node tsx
    fi

    # Create tsconfig.json using printf
    printf '%s\n' '{"compilerOptions":{"target":"ES2022","module":"NodeNext","moduleResolution":"NodeNext","strict":true,"esModuleInterop":true,"skipLibCheck":true,"outDir":"./dist"},"include":["src/**/*"],"exclude":["node_modules"]}' > tsconfig.json

    mkdir -p src
    echo 'console.log("Hello, TypeScript!");' > src/index.ts

    echo "Node.js TypeScript project initialized!"

# Installation configuration
install:
  tools:
    - name: node
      description: Node.js runtime (includes npm)
      check: "command -v node"
      methods:
        darwin:
          type: brew
          package: node
        linux/debian:
          type: apt
          package: nodejs
        linux/ubuntu:
          type: apt
          package: nodejs
        linux:
          type: brew
          package: node
      post_install:
        message: "Node.js installed. Run 'node --version' to verify."

    - name: npm
      description: Node.js package manager
      check: "command -v npm"
      methods:
        darwin:
          type: brew
          package: node
        linux/debian:
          type: apt
          package: npm
        linux/ubuntu:
          type: apt
          package: npm
        linux:
          type: brew
          package: node
      requires:
        - node

    - name: pnpm
      description: Fast, disk space efficient package manager
      check: "command -v pnpm"
      methods:
        darwin:
          type: npm
          package: pnpm
          global: true
        linux:
          type: npm
          package: pnpm
          global: true
      requires:
        - npm
      post_install:
        message: "pnpm installed. Run 'pnpm setup' for shell integration."
