# Sync component configuration
# Provides dotfiles synchronization, drift detection, and config management
name: sync
description: Dotfiles synchronization and drift detection
version: 1.0.0

# Environment variables
env:
  SYNC_AUTO_ENABLED: "${SYNC_AUTO_ENABLED:-1}"

# Convenience aliases for common operations
aliases:
  # Dotfiles operations
  df-status: "acorn sync status"
  df-pull: "acorn sync pull"
  df-push: "acorn sync push"
  df-audit: "acorn sync audit"
  df-link: "acorn sync link"
  df-unlink: "acorn sync unlink"
  df-help: "acorn sync --help"
  # Shell injection
  df-inject: "acorn shell inject"
  df-eject: "acorn shell eject"
  # Component operations
  comp-health: "acorn component health"
  comp-drift: "acorn sync drift"
  comp-validate: "acorn component validate"

# Wrapper functions that call acorn commands
wrappers:
  - name: dotfiles_sync
    command: "acorn sync"
    usage: "dotfiles_sync"

  - name: dotfiles_update
    command: "acorn sync update"
    usage: "dotfiles_update"

  - name: dotfiles_check_drift
    command: "acorn sync drift --quiet"
    usage: "dotfiles_check_drift"

# Shell functions for sync operations
shell_functions:
  # Initialize sync - auto-check for drift on shell startup
  _sync_init: |
    # Auto-sync on shell startup (if enabled and interactive)
    if [ "$IS_INTERACTIVE" = "true" ] && [ "${SYNC_AUTO_ENABLED:-1}" = "1" ]; then
        if command -v acorn >/dev/null 2>&1; then
            # Run drift check in background (non-blocking)
            (acorn sync drift --quiet 2>/dev/null &)
        fi
    fi

  # Reload shell configuration without restarting
  dotfiles_reload: |
    if [ -f "$ACORN_CONFIG_DIR/shell.sh" ]; then
        echo "Regenerating shell scripts..."
        acorn shell generate
        echo "Reloading shell configuration..."
        . "$ACORN_CONFIG_DIR/shell.sh"
        echo "Done. Shell configuration reloaded."
    else
        echo "Error: Shell entrypoint not found at $ACORN_CONFIG_DIR/shell.sh"
        echo "Run 'acorn shell install' to set up shell integration."
        return 1
    fi

  # Quick status check
  dotfiles_status: |
    echo "=== Dotfiles Status ==="
    echo ""
    echo "Environment:"
    echo "  DOTFILES_ROOT:   ${DOTFILES_ROOT:-not set}"
    echo "  ACORN_CONFIG_DIR: ${ACORN_CONFIG_DIR:-not set}"
    echo "  CURRENT_SHELL:   ${CURRENT_SHELL:-not set}"
    echo "  CURRENT_PLATFORM: ${CURRENT_PLATFORM:-not set}"
    echo ""
    if command -v acorn >/dev/null 2>&1; then
        acorn sync status
    else
        echo "acorn not found in PATH"
    fi

  # Show help for all dotfiles commands
  dotfiles_help: |
    echo "Dotfiles Management Commands"
    echo "============================"
    echo ""
    echo "Quick Commands (aliases):"
    echo "  df-status    - Show dotfiles repository status"
    echo "  df-pull      - Pull latest changes from remote"
    echo "  df-push      - Commit and push local changes"
    echo "  df-audit     - Full audit of all changes"
    echo "  df-link      - Create symlinks for config files"
    echo "  df-unlink    - Remove symlinked config files"
    echo "  df-inject    - Add acorn to shell rc file"
    echo "  df-eject     - Remove acorn from shell rc file"
    echo ""
    echo "Functions:"
    echo "  dotfiles_reload  - Regenerate and reload shell config"
    echo "  dotfiles_status  - Show environment and sync status"
    echo "  dotfiles_sync    - Full sync (pull + push)"
    echo "  dotfiles_update  - Pull and reload configuration"
    echo ""
    echo "Component Commands:"
    echo "  comp-health    - Check component health"
    echo "  comp-drift     - Show changes by component"
    echo "  comp-validate  - Validate component configs"
    echo ""
    echo "For more details: acorn sync --help"
