# Component Template System Refactor

Last updated: 2026-01-05

## Overview

Refactor all components to a standardized structure with:
- Configuration in `components/<name>/config.yaml`
- AI integration centralized in `components/claude/config/` (agents + commands)
- Go logic for typed config → file generation
- Installation scripting
- Bash/zsh completion support (optional)

## Architecture Decisions

### Component Location
- **Config**: `components/<name>/config.yaml` (single source of truth)
- **NOT** `internal/componentconfig/` (removed)

### Go's Role
- Typed configuration with validation
- Generate tool-specific files (tmux.conf, .gitconfig, etc.)
- `acorn <component> generate` command
- NOT shell function wrappers

### AI Integration (IMPORTANT)
- **Centralized location** - NOT per-component `ai/` subdirectories
- Agents: `components/claude/config/agents/<name>-expert.md`
- Commands: `components/claude/config/commands/<name>/` (subdirectory per component)
- This is the correct location, not legacy - do NOT migrate to component-specific paths

### Shell Functions
- **KEEP**: cd, source, fzf, attach, $EDITOR
- **REMOVE**: Simple wrappers that call `acorn X`

---

## Standard Component Structure

```
components/<component>/
├── config.yaml              # Single source of truth
├── README.md                # Component documentation
├── shell/                   # (optional, only if needed)
│   ├── env.sh              # Environment variables
│   ├── aliases.sh          # Command aliases
│   ├── functions.sh        # Shell functions (cd, source, fzf, attach)
│   └── completions.sh      # Bash/zsh completions
├── install/
│   └── install.sh          # Installation script
└── config/                  # Tool-specific configs (generated by Go)
    └── <tool-configs>       # e.g., tmux.conf, .gitconfig
```

**AI files are centralized (not per-component):**
```
components/claude/config/
├── agents/
│   └── <component>-expert.md
└── commands/
    └── <component>/         # Subdirectory per component
        ├── <component>-explain.md
        ├── <component>-coach.md
        └── <component>-<task>.md
```

---

## Phase 1: Create Agent & Commands - COMPLETE

- [x] Create `component-refactor-expert` agent (updated with new strategy)
- [x] Create `/component-analyze` command (updated)
- [x] Create `/component-gen-template` command (updated)
- [x] Create `/component-gen-agent` command (updated)
- [x] Create `/component-gen-commands` command (updated)
- [x] Create `/component-gen-install` command (updated)
- [x] Create `/component-gen-completions` command (updated)
- [x] Create `/component-gen-validate` command (updated)

**Files updated:**
- `components/claude/config/agents/component-refactor-expert.md`
- `components/claude/config/commands/component-analyze.md`
- `components/claude/config/commands/component-gen-*.md` (6 files)

---

## Phase 2: Process Components

### Component 1: tmux (Template Reference)

- [ ] Analyze current state (`/component-analyze tmux`)
- [ ] Review functions (approve/remove)
- [ ] Generate template structure
- [ ] Create agent
- [ ] Generate commands
- [ ] Generate install scripts
- [ ] Add completions
- [ ] Validate
- [ ] Run `acorn ai inject tmux`

### Component 2: go
- [ ] Process with same workflow

### Component 3: python
- [ ] Process with same workflow

### Component 4: node
- [ ] Process with same workflow

### Component 5: git
- [ ] Process with same workflow

### Component 6: github
- [ ] Process with same workflow

### Component 7: kubernetes
- [ ] Process with same workflow

### Component 8: fzf
- [ ] Process with same workflow

### Component 9: neovim
- [ ] Process with same workflow

### Component 10: ollama
- [ ] Process with same workflow

### Component 11: cloudflare - COMPLETE
- [x] Analyzed - no shell functions needed (all wrappers)
- [x] Created `config.yaml` with 14 aliases
- [x] Created `install/install.sh` for npm wrangler install
- [x] Updated `README.md`
- [x] AI files already exist in correct location

### Component 12: database
- [ ] Process with same workflow

### Component 13: vscode
- [ ] Process with same workflow

### Component 14: shell (core)
- [ ] Process with same workflow

### Component 15: tools
- [ ] Process with same workflow

### Component 16: secrets
- [ ] Process with same workflow

### Component 17: claude
- [ ] Process with same workflow

---

## Phase 3: Go CLI Integration

After all components are migrated:

- [ ] Create `acorn ai inject` command
- [ ] Create `acorn <component> generate` for typed config
- [ ] Update shell generation to use new paths
- [ ] Test with `acorn component list`

---

## Workflow for Each Component

```bash
# 1. Analyze the component
/component-analyze <name>

# 2. Review and approve functions
# User confirms which functions to keep/remove

# 3. Generate template structure
/component-gen-template <name>

# 4. Create agent
/component-gen-agent <name>

# 5. Generate commands
/component-gen-commands <name>

# 6. Generate install scripts
/component-gen-install <name>

# 7. Add completions
/component-gen-completions <name>

# 8. Validate all files
/component-gen-validate <name>

# 9. Inject to Claude
acorn ai inject <name>
```

---

## Quick Reference

**Component paths:**
- Config: `components/<name>/config.yaml`
- Shell scripts: `components/<name>/shell/` (optional)
- Install scripts: `components/<name>/install/`
- Tool configs: `components/<name>/config/`

**AI paths (centralized in claude component):**
- Agents: `components/claude/config/agents/<name>-expert.md`
- Commands: `components/claude/config/commands/<name>/`

**Removed/deprecated paths:**
- `internal/componentconfig/` (removed)
- `components/<name>/ai/` (DO NOT USE - was a mistake)

---

## Core Directory Status

**`core/` CANNOT be removed yet.** Both systems currently run in parallel:

```bash
# ~/.bashrc and ~/.zshrc source BOTH:
source $DOTFILES_ROOT/core/bootstrap.sh    # Old system
source ~/.config/acorn/shell.sh            # New acorn system
```

### What `core/` Still Provides:

| File | Purpose | Replacement Status |
|------|---------|-------------------|
| `sync.sh` | Drift detection (`[dotfiles] drift detected`) | `acorn dotfiles` TODO |
| `loader.sh` | Loads old-style components | 7 components not migrated |
| `xdg.sh` | XDG_* environment variables | Move to acorn entrypoint |
| `theme.sh` | THEME_* colors for sync.sh | Needed by sync.sh |
| `discovery.sh` | CURRENT_SHELL, IS_INTERACTIVE | Move to acorn |
| `bootstrap.sh` | Main entrypoint | Remove after migration |

### Components Still Using Old Loader (7):

- `intellij/` - component.yaml
- `iterm2/` - component.yaml
- `karabiner/` - component.yaml
- `r/` - component.yaml
- `shell/` - component.yaml (core shell functions)
- `ssh/` - component.yaml
- `wget/` - component.yaml

### To Remove `core/`:

1. [ ] Migrate remaining 7 components to acorn shell
2. [ ] Implement `acorn dotfiles` (status, audit, drift, link, inject, eject)
3. [ ] Move XDG setup to acorn shell entrypoint
4. [ ] Remove `core/bootstrap.sh` from shell rc files
5. [ ] Delete `core/` directory

---

## Notes

- Restart Claude Code to pick up new commands
- Plan file: `~/.claude/plans/stateful-roaming-snowflake.md`
